---
- hosts: localhost
  connection: local
  tasks:
    - name: Sync authorized ssh keys
      ansible.builtin.copy:
        content: "{{ lookup('community.sops.sops', '~/.encrypted/authorized_keys.enc', rstrip=false) }}"
        dest: "{{ ansible_env.HOME }}/.ssh/authorized_keys"
    - name: Sync ssh config
      ansible.builtin.copy:
        content: "{{ lookup('community.sops.sops', '~/.encrypted/ssh_config.enc', rstrip=false) }}"
        dest: "{{ ansible_env.HOME }}/.ssh/config"
    - name: Sync ssh server config
      become: yes
      ansible.builtin.copy:
        content: "{{ lookup('community.sops.sops', '~/.encrypted/sshd_config.enc', rstrip=false) }}"
        dest: "/etc/ssh/sshd_config"
        mode: 0600
    - name: Enable, restart ssh server
      become: yes
      ansible.builtin.systemd_service:
        name: sshd.service
        enabled: true
        state: restarted
